import React, { useState, useEffect, useRef } from 'react';
import { 
  Wand2, 
  Sparkles, 
  Briefcase, 
  Shirt, 
  CheckCircle2, 
  Copy, 
  Loader2,
  Check,
  Zap,
  Trash2,
  History as HistoryIcon,
  ChevronDown,
  ChevronUp,
  Maximize2,
  Minimize2,
  Settings2,
  Languages,
  BookOpen,
  Send,
  ArrowRight
} from 'lucide-react';

const apiKey = "";
const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";

const TONES = [
  { id: 'professional', label: 'Professional', icon: <Briefcase className="w-4 h-4" />, color: 'text-indigo-600', prompt: "Rewrite professionally for a corporate environment." },
  { id: 'casual', label: 'Casual', icon: <Shirt className="w-4 h-4" />, color: 'text-blue-500', prompt: "Rewrite in a relaxed, friendly, and conversational way." },
  { id: 'academic', label: 'Academic', icon: <BookOpen className="w-4 h-4" />, color: 'text-purple-600', prompt: "Rewrite using formal academic language and sophisticated vocabulary." },
  { id: 'linkedin', label: 'LinkedIn', icon: <Send className="w-4 h-4" />, color: 'text-sky-700', prompt: "Optimize this for a LinkedIn post with high engagement and professional networking tone." },
  { id: 'punchy', label: 'Punchy', icon: <Zap className="w-4 h-4" />, color: 'text-orange-500', prompt: "Make it extremely concise, impactful, and direct." },
  { id: 'friendly', label: 'Friendly', icon: <CheckCircle2 className="w-4 h-4" />, color: 'text-green-500', prompt: "Make it sound warm, welcoming, and empathetic." },
];

const LENGTHS = [
  { id: 'short', label: 'Concise', icon: <Minimize2 className="w-3 h-3" /> },
  { id: 'medium', label: 'Standard', icon: <Settings2 className="w-3 h-3" /> },
  { id: 'long', label: 'Detailed', icon: <Maximize2 className="w-3 h-3" /> },
];

const App = () => {
  const [inputText, setInputText] = useState("");
  const [selectedTone, setSelectedTone] = useState('professional');
  const [selectedLength, setSelectedLength] = useState('medium');
  const [results, setResults] = useState([]);
  const [history, setHistory] = useState([]);
  const [isGenerating, setIsGenerating] = useState(false);
  const [showHistory, setShowHistory] = useState(false);
  const [error, setError] = useState(null);
  const [copiedIndex, setCopiedIndex] = useState(null);

  // Stats calculation
  const wordCount = inputText.trim() ? inputText.trim().split(/\s+/).length : 0;
  const readingTime = Math.ceil(wordCount / 200);

  const callGemini = async (prompt) => {
    let delay = 1000;
    for (let i = 0; i < 5; i++) {
      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: {
              temperature: 0.8,
              responseMimeType: "application/json",
              responseSchema: {
                type: "OBJECT",
                properties: {
                  variations: {
                    type: "ARRAY",
                    items: { type: "STRING" },
                    minItems: 3,
                    maxItems: 3
                  }
                }
              }
            }
          })
        });

        if (!response.ok) throw new Error('API Error');
        const data = await response.json();
        const parsed = JSON.parse(data.candidates?.[0]?.content?.parts?.[0]?.text);
        return parsed;
      } catch (err) {
        if (i === 4) throw err;
        await new Promise(r => setTimeout(r, delay));
        delay *= 2;
      }
    }
  };

  const handleRewrite = async () => {
    if (!inputText.trim()) return;
    setIsGenerating(true);
    setError(null);
    
    const toneObj = TONES.find(t => t.id === selectedTone);
    const lengthObj = LENGTHS.find(l => l.id === selectedLength);
    
    const prompt = `
      Task: ${toneObj.prompt}
      Desired Length: ${lengthObj.label}
      Text to transform: "${inputText}"
      Requirement: Provide exactly 3 unique, high-quality variations.
    `;

    try {
      const data = await callGemini(prompt);
      const newVariations = data.variations || [];
      setResults(newVariations);
      
      // Add to history
      const historyItem = {
        original: inputText,
        tone: toneObj.label,
        variations: newVariations,
        timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
      };
      setHistory(prev => [historyItem, ...prev].slice(0, 10));
    } catch (err) {
      setError("Failed to connect to AI engine. Please try again.");
    } finally {
      setIsGenerating(false);
    }
  };

  const copyToClipboard = (text, index) => {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    try {
      document.execCommand('copy');
      setCopiedIndex(index);
      setTimeout(() => setCopiedIndex(null), 2000);
    } catch (err) {
      console.error('Failed to copy');
    }
    document.body.removeChild(textArea);
  };

  return (
    <div className="min-h-screen bg-[#F8FAFC] font-sans selection:bg-indigo-100 pb-12">
      {/* Top Navigation Bar */}
      <nav className="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-slate-200 px-4 py-3">
        <div className="max-w-md mx-auto flex items-center justify-between">
          <div className="flex items-center gap-2">
            <div className="bg-[#121826] p-1.5 rounded-lg">
              <Wand2 className="w-5 h-5 text-white" />
            </div>
            <h1 className="text-lg font-bold text-[#121826] tracking-tight">ToneShift Pro</h1>
          </div>
          <div className="flex items-center gap-3">
            <button 
              onClick={() => setShowHistory(!showHistory)}
              className={`p-2 rounded-full transition-colors ${showHistory ? 'bg-indigo-50 text-indigo-600' : 'text-slate-400 hover:bg-slate-100'}`}
            >
              <HistoryIcon className="w-5 h-5" />
            </button>
            <div className="bg-[#FFB11A] px-2.5 py-1 rounded-full flex items-center gap-1 shadow-sm border border-orange-200">
              <Zap className="w-3 h-3 text-white fill-white" />
              <span className="text-[9px] font-black text-white tracking-widest uppercase">Premium</span>
            </div>
          </div>
        </div>
      </nav>

      <main className="max-w-md mx-auto px-4 mt-6">
        {/* Editor Area */}
        <div className="bg-white rounded-[2rem] shadow-xl shadow-slate-200/50 border border-slate-100 overflow-hidden transition-all focus-within:ring-2 focus-within:ring-indigo-500/20">
          <div className="p-6">
            <div className="flex justify-between items-center mb-4">
              <div className="flex gap-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                <span>{wordCount} Words</span>
                <span>{readingTime}m Read</span>
              </div>
              <button 
                onClick={() => setInputText("")}
                className="text-[10px] font-bold text-slate-300 hover:text-red-500 transition-colors uppercase tracking-widest"
              >
                Clear All
              </button>
            </div>
            <textarea
              value={inputText}
              onChange={(e) => setInputText(e.target.value)}
              className="w-full h-40 resize-none border-none focus:ring-0 text-slate-700 text-lg leading-relaxed placeholder:text-slate-300"
              placeholder="Paste text you want to transform..."
            />
          </div>
          
          {/* Quick Settings Bar */}
          <div className="bg-slate-50/50 border-t border-slate-100 px-6 py-3 flex items-center justify-between">
            <div className="flex items-center gap-1">
               <span className="text-[10px] font-bold text-slate-400 mr-2 uppercase tracking-tighter">Length:</span>
               <div className="flex bg-slate-200/50 p-1 rounded-lg">
                 {LENGTHS.map(l => (
                   <button
                    key={l.id}
                    onClick={() => setSelectedLength(l.id)}
                    className={`px-2 py-1 rounded-md text-[10px] font-bold transition-all flex items-center gap-1 ${
                      selectedLength === l.id ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'
                    }`}
                   >
                     {l.icon}
                     {l.label}
                   </button>
                 ))}
               </div>
            </div>
            <Languages className="w-4 h-4 text-slate-300" />
          </div>
        </div>

        {/* Tone Picker */}
        <div className="mt-8 mb-4">
          <div className="flex items-center justify-between mb-3 px-2">
            <p className="text-slate-500 text-sm font-bold uppercase tracking-wide">Target Tone</p>
            <span className="text-xs text-indigo-500 font-medium">6 Styles Available</span>
          </div>
          <div className="flex overflow-x-auto gap-3 pb-2 no-scrollbar -mx-2 px-2">
            {TONES.map((tone) => (
              <button
                key={tone.id}
                onClick={() => setSelectedTone(tone.id)}
                className={`flex flex-col items-center gap-2 min-w-[90px] p-4 rounded-2xl transition-all border ${
                  selectedTone === tone.id 
                  ? 'bg-white border-indigo-500 ring-4 ring-indigo-50 shadow-md' 
                  : 'bg-white border-slate-100 text-slate-600 hover:border-slate-300'
                }`}
              >
                <div className={`p-2 rounded-xl ${selectedTone === tone.id ? 'bg-indigo-500 text-white' : 'bg-slate-50 ' + tone.color}`}>
                  {tone.icon}
                </div>
                <span className={`text-[11px] font-bold tracking-tight ${selectedTone === tone.id ? 'text-indigo-600' : 'text-slate-500'}`}>
                  {tone.label}
                </span>
              </button>
            ))}
          </div>
        </div>

        {/* Generate Button */}
        <button
          onClick={handleRewrite}
          disabled={isGenerating || !inputText.trim()}
          className="group relative w-full bg-[#121826] text-white py-5 rounded-[1.5rem] font-black text-lg flex items-center justify-center gap-3 overflow-hidden transition-all active:scale-[0.97] hover:bg-[#1e263a] disabled:opacity-40 shadow-2xl shadow-indigo-200"
        >
          {isGenerating ? (
            <Loader2 className="w-6 h-6 animate-spin text-indigo-400" />
          ) : (
            <>
              <Sparkles className="w-6 h-6 text-indigo-400 group-hover:rotate-12 transition-transform" />
              Rewrite Magic
              <ArrowRight className="w-5 h-5 opacity-50" />
            </>
          )}
        </button>

        {/* Results Section */}
        {results.length > 0 && (
          <div className="mt-10 space-y-5 animate-in fade-in slide-in-from-bottom-6 duration-500">
            <div className="flex items-center justify-between px-2">
              <h2 className="text-slate-800 font-black text-xl">Top Suggestions</h2>
              <div className="h-px flex-1 bg-slate-100 mx-4" />
            </div>
            
            {results.map((result, idx) => (
              <div 
                key={idx} 
                className="group bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100 hover:border-indigo-200 transition-all hover:shadow-lg hover:shadow-indigo-500/5"
              >
                <div className="flex justify-between items-start mb-3">
                   <div className="flex items-center gap-2">
                     <div className="w-6 h-6 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center text-[10px] font-black">
                       {idx + 1}
                     </div>
                     <span className="text-[10px] font-black text-slate-300 uppercase tracking-widest">Variation</span>
                   </div>
                   <button 
                    onClick={() => copyToClipboard(result, idx)}
                    className={`p-2.5 rounded-xl transition-all ${
                      copiedIndex === idx 
                      ? 'bg-green-500 text-white' 
                      : 'bg-slate-50 text-slate-400 group-hover:bg-indigo-50 group-hover:text-indigo-600'
                    }`}
                  >
                    {copiedIndex === idx ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
                  </button>
                </div>
                <p className="text-slate-700 text-lg leading-relaxed font-medium">
                  {result}
                </p>
              </div>
            ))}
          </div>
        )}

        {/* History Modal-like Overlay */}
        {showHistory && (
          <div className="fixed inset-0 z-[60] bg-white overflow-y-auto animate-in slide-in-from-right duration-300 p-6">
            <div className="flex items-center justify-between mb-8">
              <h2 className="text-2xl font-black text-slate-800 flex items-center gap-2">
                <HistoryIcon className="w-6 h-6 text-indigo-500" />
                Session History
              </h2>
              <button 
                onClick={() => setShowHistory(false)}
                className="p-2 bg-slate-100 rounded-full text-slate-500"
              >
                <ChevronUp className="w-6 h-6" />
              </button>
            </div>
            
            {history.length === 0 ? (
              <div className="text-center py-20 text-slate-400">
                <p>No rewrites yet this session.</p>
              </div>
            ) : (
              <div className="space-y-8">
                {history.map((item, i) => (
                  <div key={i} className="border-b border-slate-100 pb-8">
                    <div className="flex items-center justify-between mb-4">
                      <span className="text-[10px] font-black bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full uppercase tracking-tighter">
                        {item.tone} Style
                      </span>
                      <span className="text-[10px] font-bold text-slate-400">{item.timestamp}</span>
                    </div>
                    <p className="text-xs text-slate-400 italic mb-4 line-clamp-1">Original: "{item.original}"</p>
                    <div className="bg-slate-50 rounded-2xl p-4">
                      <p className="text-sm text-slate-700 font-semibold">{item.variations[0]}</p>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {/* Footer/Empty State */}
        {!isGenerating && results.length === 0 && (
          <div className="text-center py-20 opacity-40">
            <div className="bg-slate-200 w-20 h-20 rounded-[2rem] flex items-center justify-center mx-auto mb-6 transform rotate-12">
              <Wand2 className="w-10 h-10 text-slate-400" />
            </div>
            <p className="text-slate-500 font-bold">Write something brilliant.</p>
            <p className="text-slate-400 text-xs mt-1 uppercase tracking-widest">Powered by Gemini Pro</p>
          </div>
        )}
      </main>

      {/* Global CSS for scrollbars */}
      <style dangerouslySetInnerHTML={{ __html: `
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      `}} />
    </div>
  );
};

export default App;
