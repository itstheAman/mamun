import React, { useState, useEffect, useRef } from 'react';
import { 
  Wand2, 
  Sparkles, 
  Briefcase, 
  Shirt, 
  CheckCircle2, 
  Copy, 
  Loader2,
  Check,
  Zap,
  History as HistoryIcon,
  ChevronUp,
  Maximize2,
  Minimize2,
  Settings2,
  Languages,
  BookOpen,
  Send,
  ArrowRight,
  Eraser,
  CheckCheck,
  AlignLeft,
  PenTool
} from 'lucide-react';

const apiKey = "";
const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";

const TONES = [
  { id: 'grammar', label: 'Fix Grammar', icon: <CheckCheck className="w-4 h-4" />, color: 'text-emerald-500', prompt: "Correct the grammar, spelling, and punctuation. Provide 3 versions: 1) Minimal correction, 2) Flow optimized, 3) Sophisticated." },
  { id: 'professional', label: 'Professional', icon: <Briefcase className="w-4 h-4" />, color: 'text-indigo-600', prompt: "Rewrite professionally for a corporate environment." },
  { id: 'casual', label: 'Casual', icon: <Shirt className="w-4 h-4" />, color: 'text-blue-500', prompt: "Rewrite in a relaxed, friendly, and conversational way." },
  { id: 'summarize', label: 'Summarize', icon: <AlignLeft className="w-4 h-4" />, color: 'text-rose-500', prompt: "Summarize this text in 3 different ways: 1) One sentence, 2) Three bullet points, 3) Short paragraph." },
  { id: 'continue', label: 'Continue', icon: <PenTool className="w-4 h-4" />, color: 'text-amber-500', prompt: "Continue writing based on this context. Provide 3 different directions the text could take." },
  { id: 'linkedin', label: 'LinkedIn', icon: <Send className="w-4 h-4" />, color: 'text-sky-700', prompt: "Optimize this for a LinkedIn post with networking value." },
  { id: 'academic', label: 'Academic', icon: <BookOpen className="w-4 h-4" />, color: 'text-purple-600', prompt: "Rewrite using formal academic language." },
  { id: 'friendly', label: 'Friendly', icon: <CheckCircle2 className="w-4 h-4" />, color: 'text-green-500', prompt: "Make it sound warm and welcoming." },
];

const LENGTHS = [
  { id: 'short', label: 'Concise', icon: <Minimize2 className="w-3 h-3" /> },
  { id: 'medium', label: 'Balanced', icon: <Settings2 className="w-3 h-3" /> },
  { id: 'long', label: 'Detailed', icon: <Maximize2 className="w-3 h-3" /> },
];

const App = () => {
  const [inputText, setInputText] = useState("");
  const [selectedTone, setSelectedTone] = useState('grammar');
  const [selectedLength, setSelectedLength] = useState('medium');
  const [results, setResults] = useState([]);
  const [history, setHistory] = useState([]);
  const [isGenerating, setIsGenerating] = useState(false);
  const [showHistory, setShowHistory] = useState(false);
  const [error, setError] = useState(null);
  const [copiedIndex, setCopiedIndex] = useState(null);

  const wordCount = inputText.trim() ? inputText.trim().split(/\s+/).length : 0;

  const callGemini = async (prompt) => {
    let delay = 1000;
    for (let i = 0; i < 5; i++) {
      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: {
              temperature: 0.8,
              responseMimeType: "application/json",
              responseSchema: {
                type: "OBJECT",
                properties: {
                  variations: {
                    type: "ARRAY",
                    items: { type: "STRING" },
                    minItems: 3,
                    maxItems: 3
                  }
                }
              }
            }
          })
        });

        if (!response.ok) throw new Error('API Error');
        const data = await response.json();
        return JSON.parse(data.candidates?.[0]?.content?.parts?.[0]?.text);
      } catch (err) {
        if (i === 4) throw err;
        await new Promise(r => setTimeout(r, delay));
        delay *= 2;
      }
    }
  };

  const handleRewrite = async () => {
    if (!inputText.trim()) return;
    setIsGenerating(true);
    setError(null);
    
    const toneObj = TONES.find(t => t.id === selectedTone);
    const lengthObj = LENGTHS.find(l => l.id === selectedLength);
    
    const prompt = `
      Action: ${toneObj.prompt}
      Desired Result Length: ${lengthObj.label}
      Input: "${inputText}"
      Format: Provide 3 distinct variations in a JSON array called "variations".
    `;

    try {
      const data = await callGemini(prompt);
      const newVariations = data.variations || [];
      setResults(newVariations);
      
      const historyItem = {
        original: inputText,
        tone: toneObj.label,
        variations: newVariations,
        timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
      };
      setHistory(prev => [historyItem, ...prev].slice(0, 10));
    } catch (err) {
      setError("AI service interrupted. Please try again.");
    } finally {
      setIsGenerating(false);
    }
  };

  const copyToClipboard = (text, index) => {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    try {
      document.execCommand('copy');
      setCopiedIndex(index);
      setTimeout(() => setCopiedIndex(null), 2000);
    } catch (err) {
      console.error('Copy failed');
    }
    document.body.removeChild(textArea);
  };

  return (
    <div className="min-h-screen bg-[#FDFDFF] font-sans selection:bg-indigo-100 pb-12">
      {/* Premium Header */}
      <nav className="sticky top-0 z-50 bg-white/70 backdrop-blur-xl border-b border-slate-100 px-6 py-4">
        <div className="max-w-xl mx-auto flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="bg-gradient-to-br from-[#121826] to-[#2D364D] p-2 rounded-xl shadow-lg shadow-indigo-100">
              <Wand2 className="w-5 h-5 text-white" />
            </div>
            <div>
              <h1 className="text-xl font-bold text-[#121826] tracking-tight leading-none">ToneShift</h1>
              <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">Intelligence Studio</p>
            </div>
          </div>
          <div className="flex items-center gap-2">
            <button 
              onClick={() => setShowHistory(!showHistory)}
              className={`p-2.5 rounded-full transition-all ${showHistory ? 'bg-indigo-600 text-white shadow-indigo-200 shadow-lg' : 'text-slate-400 hover:bg-slate-100'}`}
            >
              <HistoryIcon className="w-5 h-5" />
            </button>
            <div className="bg-[#121826] pl-2 pr-3 py-1.5 rounded-full flex items-center gap-1.5 shadow-sm">
              <div className="bg-[#FFB11A] p-1 rounded-full">
                <Zap className="w-2.5 h-2.5 text-white fill-white" />
              </div>
              <span className="text-[10px] font-black text-white tracking-widest uppercase">Elite</span>
            </div>
          </div>
        </div>
      </nav>

      <main className="max-w-xl mx-auto px-6 mt-8">
        {/* Workspace Card */}
        <div className="bg-white rounded-[2.5rem] shadow-[0_20px_50px_-12px_rgba(0,0,0,0.05)] border border-slate-100 overflow-hidden transition-all group">
          <div className="p-8 pb-4">
            <div className="flex justify-between items-center mb-6">
              <div className="flex gap-4 items-center">
                <div className="h-2 w-2 rounded-full bg-indigo-500 animate-pulse" />
                <span className="text-[11px] font-bold text-slate-400 uppercase tracking-widest">{wordCount} Words</span>
              </div>
              <button 
                onClick={() => setInputText("")}
                className="group/btn flex items-center gap-1.5 text-[10px] font-bold text-slate-300 hover:text-rose-500 transition-colors uppercase tracking-widest"
              >
                <Eraser className="w-3 h-3" />
                Clear
              </button>
            </div>
            <textarea
              value={inputText}
              onChange={(e) => setInputText(e.target.value)}
              className="w-full h-48 resize-none border-none focus:ring-0 text-slate-700 text-xl font-medium leading-relaxed placeholder:text-slate-200 placeholder:font-normal"
              placeholder="Paste text or start writing..."
            />
          </div>
          
          <div className="bg-slate-50/50 px-8 py-4 flex items-center justify-between border-t border-slate-50">
            <div className="flex items-center gap-2">
               <span className="text-[10px] font-black text-slate-400 uppercase tracking-tighter">Output Strategy</span>
               <div className="flex bg-white/80 backdrop-blur shadow-sm p-1 rounded-xl border border-slate-100">
                 {LENGTHS.map(l => (
                   <button
                    key={l.id}
                    onClick={() => setSelectedLength(l.id)}
                    className={`px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all flex items-center gap-1.5 ${
                      selectedLength === l.id ? 'bg-[#121826] text-white shadow-md' : 'text-slate-400 hover:text-slate-600'
                    }`}
                   >
                     {l.label}
                   </button>
                 ))}
               </div>
            </div>
          </div>
        </div>

        {/* Improved Tone Carousel */}
        <div className="mt-10 mb-6">
          <p className="text-slate-800 text-xs font-black uppercase tracking-widest mb-4 ml-2">Studio Tools</p>
          <div className="flex overflow-x-auto gap-4 pb-4 no-scrollbar -mx-2 px-2">
            {TONES.map((tone) => (
              <button
                key={tone.id}
                onClick={() => setSelectedTone(tone.id)}
                className={`flex items-center gap-3 px-6 py-4 rounded-[1.25rem] transition-all border whitespace-nowrap group ${
                  selectedTone === tone.id 
                  ? 'bg-white border-indigo-200 shadow-[0_10px_25px_-5px_rgba(99,102,241,0.15)] ring-1 ring-indigo-500/20' 
                  : 'bg-white border-slate-100 text-slate-500 hover:border-slate-300'
                }`}
              >
                <div className={`p-2.5 rounded-xl transition-colors ${selectedTone === tone.id ? 'bg-indigo-600 text-white' : 'bg-slate-50 ' + tone.color}`}>
                  {tone.icon}
                </div>
                <div className="text-left">
                  <span className={`block text-xs font-black tracking-tight ${selectedTone === tone.id ? 'text-indigo-600' : 'text-slate-600'}`}>
                    {tone.label}
                  </span>
                  <span className="block text-[9px] text-slate-400 font-medium">Enhanced</span>
                </div>
              </button>
            ))}
          </div>
        </div>

        {/* Generate Magic Button */}
        <button
          onClick={handleRewrite}
          disabled={isGenerating || !inputText.trim()}
          className="relative w-full bg-gradient-to-r from-[#121826] to-[#1E293B] text-white py-6 rounded-[2rem] font-bold text-lg flex items-center justify-center gap-3 overflow-hidden transition-all active:scale-[0.98] hover:shadow-2xl hover:shadow-indigo-200 disabled:opacity-40 group"
        >
          {isGenerating ? (
            <div className="flex items-center gap-3">
              <Loader2 className="w-6 h-6 animate-spin text-indigo-400" />
              <span className="tracking-widest uppercase text-sm font-black animate-pulse">Processing...</span>
            </div>
          ) : (
            <>
              <Sparkles className="w-6 h-6 text-indigo-400 group-hover:animate-bounce" />
              <span className="tracking-tight">Transform Content</span>
              <ArrowRight className="w-5 h-5 opacity-40 group-hover:translate-x-1 transition-transform" />
            </>
          )}
        </button>

        {/* Error Notification */}
        {error && (
          <div className="mt-6 bg-rose-50 text-rose-600 p-5 rounded-3xl border border-rose-100 flex items-center gap-3 animate-in fade-in zoom-in">
            <Zap className="w-5 h-5 text-rose-400" />
            <span className="text-sm font-bold">{error}</span>
          </div>
        )}

        {/* Result Cards */}
        {results.length > 0 && (
          <div className="mt-12 space-y-6 animate-in slide-in-from-bottom-10 duration-700">
            <div className="flex items-center gap-4 px-2">
              <h2 className="text-slate-900 font-black text-xl tracking-tighter">Variations</h2>
              <div className="h-[2px] flex-1 bg-gradient-to-r from-slate-100 to-transparent" />
            </div>
            
            {results.map((result, idx) => (
              <div 
                key={idx} 
                className="bg-white p-8 rounded-[2.5rem] shadow-[0_15px_30px_-10px_rgba(0,0,0,0.03)] border border-slate-50 hover:border-indigo-100 transition-all group/card relative"
              >
                <div className="flex justify-between items-center mb-4">
                   <div className="flex items-center gap-2">
                     <div className="w-8 h-8 rounded-xl bg-slate-50 text-slate-400 flex items-center justify-center text-xs font-black group-hover/card:bg-indigo-600 group-hover/card:text-white transition-all">
                       0{idx + 1}
                     </div>
                     <span className="text-[10px] font-black text-slate-300 uppercase tracking-widest group-hover/card:text-indigo-400 transition-colors">AI Result</span>
                   </div>
                   <button 
                    onClick={() => copyToClipboard(result, idx)}
                    className={`flex items-center gap-2 px-4 py-2 rounded-full transition-all text-xs font-bold ${
                      copiedIndex === idx 
                      ? 'bg-emerald-500 text-white shadow-lg shadow-emerald-100' 
                      : 'bg-slate-50 text-slate-400 hover:bg-indigo-50 hover:text-indigo-600'
                    }`}
                  >
                    {copiedIndex === idx ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
                    {copiedIndex === idx ? 'Copied' : 'Copy'}
                  </button>
                </div>
                <p className="text-slate-700 text-xl leading-relaxed font-medium">
                  {result}
                </p>
              </div>
            ))}
          </div>
        )}

        {/* History Modal */}
        {showHistory && (
          <div className="fixed inset-0 z-[60] bg-white/95 backdrop-blur-2xl overflow-y-auto animate-in slide-in-from-right duration-500 p-8">
            <div className="max-w-xl mx-auto">
              <div className="flex items-center justify-between mb-12">
                <h2 className="text-3xl font-black text-slate-900 tracking-tighter flex items-center gap-3">
                  <HistoryIcon className="w-8 h-8 text-indigo-600" />
                  Journal
                </h2>
                <button 
                  onClick={() => setShowHistory(false)}
                  className="p-3 bg-[#121826] text-white rounded-full shadow-xl hover:scale-110 transition-transform"
                >
                  <ChevronUp className="w-7 h-7" />
                </button>
              </div>
              
              {history.length === 0 ? (
                <div className="text-center py-32">
                  <p className="text-slate-400 font-bold uppercase tracking-widest">No previous transformations</p>
                </div>
              ) : (
                <div className="space-y-10">
                  {history.map((item, i) => (
                    <div key={i} className="group border-b border-slate-100 pb-10">
                      <div className="flex items-center justify-between mb-4">
                        <span className="text-[10px] font-black bg-slate-900 text-white px-4 py-1.5 rounded-full uppercase tracking-widest">
                          {item.tone}
                        </span>
                        <span className="text-xs font-bold text-slate-400">{item.timestamp}</span>
                      </div>
                      <p className="text-sm text-slate-400 font-medium mb-6 line-clamp-2 px-4 border-l-2 border-slate-200">{item.original}</p>
                      <div className="bg-white border border-slate-100 rounded-3xl p-6 shadow-sm group-hover:shadow-md transition-shadow">
                        <p className="text-slate-800 font-semibold leading-relaxed">{item.variations[0]}</p>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        )}

        {/* Empty State Illustration */}
        {!isGenerating && results.length === 0 && (
          <div className="text-center py-24 group">
            <div className="relative w-32 h-32 mx-auto mb-8">
              <div className="absolute inset-0 bg-indigo-50 rounded-[3rem] rotate-12 group-hover:rotate-0 transition-transform duration-500" />
              <div className="absolute inset-0 flex items-center justify-center">
                <Sparkles className="w-12 h-12 text-indigo-500" />
              </div>
            </div>
            <h3 className="text-slate-800 font-black text-xl tracking-tight mb-2">Ready to refine?</h3>
            <p className="text-slate-400 text-sm font-medium">Select a tool and watch your ideas evolve.</p>
          </div>
        )}
      </main>

      <style dangerouslySetInnerHTML={{ __html: `
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes float { 
          0%, 100% { transform: translateY(0); }
          50% { transform: translateY(-10px); }
        }
      `}} />
    </div>
  );
};

export default App;
